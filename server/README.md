## P### Initial Setup and Migration

1. Generate the migration files:
  ```bash
  npx prisma migrate dev --name init
  ```
  This creates a new migration based on your schema changes.

2. Apply the migration to the database:
  ```bash
  npx prisma migrate deploy
  ```
  This applies pending migrations to your database.

3. Generate Prisma Client:
  ```bash
  npx prisma generate
  ```
  This command is crucial as it:
  - Generates the Prisma Client based on your schema
  - Creates TypeScript types for your models
  - Must be run after any changes to `schema.prisma`
  - Must be run before running seeds or starting the server
  - Creates the `@prisma/client` package in your `node_modules`

  If you see errors about missing `PrismaClient`, run this command to fix them.

Note: Make sure your database is running before executing these commands.gration

This section covers how to set up your database using Prisma. Make sure your database is running before executing these commands.

### Initial Setup and Migration

1. Generate the migration files:
  ```bash
  npx prisma migrate dev --name init
  ```

2. Apply the migration to the database:
  ```bash
  npx prisma migrate deploy
  ```

3. Generate Prisma Client:
  ```bash
  npx prisma generate
  ```

### Prisma Studio

To interact with your database using a GUI:

```bash
npx prisma studio
```

Prisma Studio provides:
- Visual interface to view and edit data
- Table relationships visualization
- Easy CRUD operations
- Data filtering and sorting
- Real-time updates
- Access at `http://localhost:5555` by default

### Database Seeding

To populate your database with initial test data:

1. First ensure you have compiled the TypeScript seed file:
  ```bash
  npx tsc prisma/seeds.ts --outDir dist
  ```

2. Run the seed command:
  ```bash
  npx prisma db seed
  ```

The seed will create:
- Two initial lessons: "Basic Arithmetic" and "Introduction to Algebra"
- Multiple problems for each lesson with various types (multiple choice and input)
- Problem options for multiple choice questions

Note: You can modify the seed data in `prisma/seeds.ts` to add or change the initial data.

## Database Schema

The database schema has been updated to include the following models:
- **User**: Represents a user in the system.
- **Lesson**: Represents a lesson containing multiple problems.
- **Problem**: Represents a problem within a lesson, which can have multiple options.
- **ProblemOption**: Represents an option for a problem, indicating whether it is correct or not.
- **Submission**: Represents a user's submission for a problem.
- **UserProgress**: Represents the progress of a user in a lesson.

This is the sql migration script that will be generated by Prisma:

```sql
-- ==============================
-- 1. USERS
-- ==============================
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE,
    total_xp INT DEFAULT 0,
    current_streak INT DEFAULT 0,
    best_streak INT DEFAULT 0,
    last_activity_date DATE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ==============================
-- 2. LESSONS
-- ==============================
CREATE TABLE lessons (
    id SERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    order_index INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ==============================
-- 3. PROBLEMS
-- ==============================
CREATE TABLE problems (
    id SERIAL PRIMARY KEY,
    lesson_id INT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- e.g. multiple_choice, input
    question TEXT NOT NULL,
    correct_answer TEXT NOT NULL, -- never sent to frontend
    xp_value INT DEFAULT 10,
    order_index INT DEFAULT 0
);

CREATE INDEX idx_problems_lesson ON problems(lesson_id);

-- ==============================
-- 4. PROBLEM OPTIONS
-- ==============================
CREATE TABLE problem_options (
    id SERIAL PRIMARY KEY,
    problem_id INT NOT NULL REFERENCES problems(id) ON DELETE CASCADE,
    option_text TEXT NOT NULL,
    is_correct BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_problem_options_problem ON problem_options(problem_id);

-- ==============================
-- 5. SUBMISSIONS
-- ==============================
CREATE TABLE submissions (
    id SERIAL PRIMARY KEY,
    attempt_id UUID NOT NULL UNIQUE,
    user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    lesson_id INT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
    problem_id INT NOT NULL REFERENCES problems(id) ON DELETE CASCADE,
    user_answer TEXT NOT NULL,
    is_correct BOOLEAN NOT NULL,
    xp_awarded INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_submissions_attempt_id ON submissions(attempt_id);

-- ==============================
-- 6. USER PROGRESS
-- ==============================
CREATE TABLE user_progress (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    lesson_id INT NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
    problems_completed INT DEFAULT 0,
    total_problems INT DEFAULT 0,
    progress_percent NUMERIC(5,2) DEFAULT 0.00,
    completed BOOLEAN DEFAULT FALSE,
    last_attempt_at TIMESTAMP
);

CREATE UNIQUE INDEX idx_user_progress_user_lesson
ON user_progress(user_id, lesson_id);

-- ==============================
-- 7. TRIGGERS & UPDATED_AT HANDLING (optional)
-- ==============================
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
   NEW.updated_at = NOW();
   RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER set_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```